<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test - Rapid Azure Digest</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .test-container { max-width: 800px; margin: 0 auto; }
        .result { margin: 20px 0; padding: 15px; border-radius: 5px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .loading { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; margin: 10px 5px; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        pre { background-color: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª Azure Static Web Apps Managed Functions API Test</h1>
        
        <div class="test-section">
            <h2>ğŸ“± ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã®APIã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ</h2>
            <p>Managed Functionsã¯Azure Static Web Appså†…éƒ¨ã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ã€‚</p>
            
            <button onclick="testApiAccess()">ğŸš€ /api/articles ã‚’ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="testApiWithAuth()">ğŸ” èªè¨¼ä»˜ããƒ†ã‚¹ãƒˆ</button>
            <button onclick="showApiInfo()">â„¹ï¸ APIä»•æ§˜è¡¨ç¤º</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        async function testApiAccess() {
            const resultDiv = document.getElementById('results');
            resultDiv.innerHTML = '<div class="result loading">ğŸ”„ APIå‘¼ã³å‡ºã—ä¸­...</div>';

            try {
                console.log('Fetching /api/articles...');
                const response = await fetch('/api/articles', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);

                if (response.ok) {
                    const data = await response.json();
                    console.log('Response data:', data);
                    
                    resultDiv.innerHTML = `
                        <div class="result success">
                            <h3>âœ… APIå‘¼ã³å‡ºã—æˆåŠŸï¼</h3>
                            <p><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> ${response.status}</p>
                            <p><strong>è¨˜äº‹ä»¶æ•°:</strong> ${data.articles ? data.articles.length : 0}ä»¶</p>
                            <p><strong>æœ€çµ‚æ›´æ–°:</strong> ${data.lastUpdated || 'N/A'}</p>
                            <details>
                                <summary>ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</summary>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    const errorText = await response.text();
                    console.log('Error response:', errorText);
                    
                    if (response.status === 404) {
                        resultDiv.innerHTML = `
                            <div class="result error">
                                <h3>âŒ APIé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (404)</h3>
                                <p><strong>å¯èƒ½æ€§1:</strong> é–¢æ•°ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæœªå®Œäº†</p>
                                <p><strong>å¯èƒ½æ€§2:</strong> index.tsã§ã®é–¢æ•°importãŒä¸æ­£</p>
                                <p><strong>å¯èƒ½æ€§3:</strong> ãƒ“ãƒ«ãƒ‰è¨­å®šã®å•é¡Œ</p>
                                <p><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> ${response.status}</p>
                                <details>
                                    <summary>ã‚¨ãƒ©ãƒ¼è©³ç´°</summary>
                                    <pre>${errorText}</pre>
                                </details>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="result error">
                                <h3>âŒ APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼ (${response.status})</h3>
                                <p>Cosmos DBæ¥ç¶šè¨­å®šã‚„ãã®ä»–ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„</p>
                                <details>
                                    <summary>ã‚¨ãƒ©ãƒ¼è©³ç´°</summary>
                                    <pre>${errorText}</pre>
                                </details>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Fetch error:', error);
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>ğŸš¨ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼</h3>
                        <p><strong>ã‚¨ãƒ©ãƒ¼:</strong> ${error.message}</p>
                        <p>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚„CORSè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„</p>
                    </div>
                `;
            }
        }

        async function testApiWithAuth() {
            const resultDiv = document.getElementById('results');
            resultDiv.innerHTML = '<div class="result loading">ğŸ” èªè¨¼æƒ…å ±ç¢ºèªä¸­...</div>';

            try {
                // èªè¨¼æƒ…å ±ç¢ºèª
                const authResponse = await fetch('/.auth/me');
                const authData = await authResponse.json();
                
                if (authData.clientPrincipal) {
                    resultDiv.innerHTML += `
                        <div class="result success">
                            <h3>âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æ¸ˆã¿</h3>
                            <p><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼:</strong> ${authData.clientPrincipal.userDetails}</p>
                            <p><strong>ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼:</strong> ${authData.clientPrincipal.identityProvider}</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML += `
                        <div class="result">
                            <h3>â„¹ï¸ åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼</h3>
                            <p>èªè¨¼ãªã—ã§APIã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™</p>
                        </div>
                    `;
                }

                // èªè¨¼ä»˜ãAPIå‘¼ã³å‡ºã—
                await testApiAccess();

            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>ğŸš¨ èªè¨¼ç¢ºèªã‚¨ãƒ©ãƒ¼</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function showApiInfo() {
            document.getElementById('results').innerHTML = `
                <div class="result">
                    <h3>ğŸ“‹ Azure Static Web Apps Managed Functions ä»•æ§˜</h3>
                    <ul>
                        <li><strong>ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•:</strong> ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ç›¸å¯¾ãƒ‘ã‚¹ <code>/api/articles</code></li>
                        <li><strong>å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹:</strong> âŒ ä¸å¯ï¼ˆCURLã€Postmanãªã©ï¼‰</li>
                        <li><strong>èªè¨¼çµ±åˆ:</strong> âœ… Azure Static Web Appsèªè¨¼ã¨çµ±åˆ</li>
                        <li><strong>CORS:</strong> âœ… è‡ªå‹•è¨­å®šï¼ˆè¨­å®šä¸è¦ï¼‰</li>
                        <li><strong>æœ€å¤§å®Ÿè¡Œæ™‚é–“:</strong> 45ç§’</li>
                        <li><strong>ãƒˆãƒªã‚¬ãƒ¼:</strong> HTTP ã®ã¿</li>
                    </ul>
                    
                    <h4>ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h4>
                    <ol>
                        <li><code>api/src/index.ts</code> ã§é–¢æ•°ã‚’importã—ã¦ã„ã‚‹ã‹ç¢ºèª</li>
                        <li>TypeScript ãƒ“ãƒ«ãƒ‰ãŒæ­£å¸¸å®Œäº†ã—ã¦ã„ã‚‹ã‹ç¢ºèª</li>
                        <li>SWA CLIã§ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¦ã„ã‚‹ã‹ç¢ºèª</li>
                        <li>ç’°å¢ƒå¤‰æ•°ï¼ˆCosmos DBè¨­å®šãªã©ï¼‰ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª</li>
                    </ol>
                </div>
            `;
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        window.addEventListener('load', function() {
            console.log('Azure Static Web Apps API Test Page Loaded');
            showApiInfo();
        });
    </script>
</body>
</html>